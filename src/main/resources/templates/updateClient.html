<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">

<div layout:fragment="content">

    <h2>Edycja klienta</h2>

    <form id="clientForm">

        <input type="hidden" id="clientId" th:value="${client.id}"/>

        <label>Login</label>
        <input type="text"
               id="login"
               th:value="${client.login}"
               maxlength="50"
               required/>

        <label>Email</label>
        <input type="email"
               id="email"
               th:value="${client.email}"
               maxlength="50"
               required/>

        <hr/>

        <label>Imię</label>
        <input type="text"
               id="firstName"
               th:value="${client.firstName}"
               maxlength="50"
               required/>

        <label>Nazwisko</label>
        <input type="text"
               id="lastName"
               th:value="${client.lastName}"
               maxlength="50"
               required/>

        <label>Telefon</label>
        <input type="text"
               id="phone"
               th:value="${client.phone}"
               pattern="[0-9]{9}"
               required/>

        <br/><br/>

        <button type="submit">Zapisz zmiany</button>
        <a th:href="@{/view/users}">Anuluj</a>

    </form>

    <div id="message"></div>

    <script>
        document.getElementById("clientForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const id = document.getElementById("clientId").value;

            const data = {
                login: document.getElementById("login").value,
                email: document.getElementById("email").value,
                firstName: document.getElementById("firstName").value,
                lastName: document.getElementById("lastName").value,
                phone: document.getElementById("phone").value
            };

            const messageDiv = document.getElementById("message");
            messageDiv.innerHTML = "";

            try {
                const response = await fetch(`/users/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || "Błąd walidacji");
                }

                alert("Zapisano zmiany klienta");
                window.location.href = "/view/users";

            } catch (err) {
                messageDiv.innerHTML =
                    "<div class='error'>" + err.message + "</div>";
            }
        });
    </script>

</div>

</html>
